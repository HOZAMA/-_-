Основы работы с IPTABLES
------------------------

IPTABLES — это утилита командной строки, используемая для управления встроенным брандмауэром NETFILTER, доступным в ядре Linux, начиная с версии 2.4. Брандмауэр — это узел сети, на котором происходит фильтрация сетевого трафика на основе заданных администратором правил. Обеспечить безопасность сервера или инфраструктуры, означает обеспечить отказоустойчивость и стабильность работы ваших серверов и приложений, что крайне чувствительно для бизнеса или персональных проектов.

В глобальной сети огромное количество угроз — боты, периодически прощупывают стандартные точки входа в системы, хулиганы, любопытные, взломщики — люди, целенаправленно пытающиеся получить несанкционированный доступ к информационным системам. Задача iptables — исключить, либо, по крайней мере, минимизировать негативное воздействие со стороны разного рода правонарушителей.

Начиная своё знакомство с IPTABLES, следует рассказать про NETFILTER. 

NETFILTER
=======================

NETFILTER - это набор программных хуков внутри ядра Linux, которые позволяют модулям ядра регистрировать функции обратного вызова от стека сетевых протоколов.
HOOK - это программный элемент, который позволяет перехватывать функции обратного вызова в чужих процессах.

NETFILTER является основой для построения Firewall'а в дистрибутивах Linux. Как раз с помощью IPTABLES мы можем взаимодействовать с хуками NETFILTER и создавать правила фильтрации, маршрутизации, изменения и транслирования пакетов.

NETFILTER использует четыре таблицы, которые хранят правила, регулирующие три вида операций над пакетами:

* filter: касается правил фильтрации (принять, отклонить, или проигнорировать пакет);
* nat (Network Address Translation): касается трансляции адресов источника, получателя, или портов пакета;
* mangle: касается других изменений IP-пакетов (включая поля и параметры ToS — Type of Service);
* raw: позволяет выполнять ручные модификации пакетов до того, как они дошли до системы отслеживания соединения.

Каждая таблица содержит списки правил, называемые цепочками. Файрвол использует стандартные цепочки для обработки пакетов, основываясь на предопределённых условиях. Администратор может создавать другие цепочки, которые будут использованы только в случаях, когда на них, прямо или косвенно, ссылается одна из стандартных цепочек.

### Таблицы

Существует 5 таблиц:

* filter - таблица, выполняющая функции фильтрации пакетов по определённым параметрам. В большинстве случаев вы будете использовать именно её. Содержит следующие встроенные цепочки: FORWARD, INPUT, OUTPUT;
* raw - чтобы понять предназначение этой таблицы, нужно понимать логику работы statefull firewall'а. Дело в том, что по умолчанию, iptables рассматривает каждый пакет как часть большого потока и может определить какому соединению принадлежит тот или иной пакет. С помощью raw таблицы настраиваются исключения, которые будут рассматривать пакет как отдельную, ни к чему не привязанную сущность. Содержит следующие встроенные цепочки: INPUT, OUTPUT;
* nat - таблица, предназначенная целиком по функции трансляции сетевых адресов. Содержит следующие встроенные цепочки: PREROUTING, OUTPUT, POSTROUTING;
* mangle - таблица, предназначенная для изменения различных заголовков пакета. Можно, например, изменить TTL, количество hop'ов и другое. Содержит следующие встроенные цепочки: PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING>;
* security - используется для назначения пакетам или соединениям неких меток, которые в дальнейшем может интерпретировать SElinux.

### Виды действий в правиле.
Каждая цепочка представляет собой список правил. Каждое правило — это набор условий и действий, которые должны быть выполнены при соблюдении соответствующих условий. В процессе обработки пакета файрвол просматривает подходящую цепочку, правило за правилом, и, когда условия для некоего правила выполняются, он «перепрыгивает» (отсюда и опция -j — от слова «jump») к заданному действию для продолжения обработки пакета.

Наиболее распространённые шаблоны поведения стандартизированы, для них существуют выделенные действия. Выполнение одного из этих стандартных действий прерывает проход по цепочке, так как судьба пакета уже предопределена (это не касается упомянутых ниже исключений). Вот список действий NETFILTER:

* ACCEPT: позволяет пакету следовать своим путём.
* REJECT: отклоняет пакет, генерируя пакет-ошибку ICMP (Internet Control Message Protocol). Опция IPTABLES --reject-with type позволяет задать тип выдаваемой ошибки.
* DROP: удалить (проигнорировать) пакет.
* LOG: записать в системный журнал сообщение (через syslogd) с описанием пакета. Обратите внимание на то, что это действие не прерывает обработку пакета, выполнение цепочки продолжается со следующего правила. Именно поэтому логирование отклонённых пакетов требует наличия правил LOG и REJECT/DROP. Среди часто используемых параметров, касающихся логирования, можно отметить следующие:
* ULOG: логирует сообщения с использованием ulogd. Такой подход может оказаться эффективнее чем syslogd при обработке большого количества сообщений. Обратите внимание на то, что это действие, как и LOG, не прерывает обработку пакета.
* chain_name: переход к заданной цепочке и обработка её правил.
* RETURN: прерывание обработки текущей цепочки и возврат к вызывающей цепочке. В том случае, если текущей цепочкой является одна из стандартных, вызывающей цепочки нет, поэтому вместо этого выполняется действие по умолчанию (заданное с помощью опции -P команды IPTABLES).
* SNAT (только в таблице nat): применяет Source Network Address Translation (SNAT). Дополнительные опции описывают то, какие именно изменения нужно выполнить, включая опцию --to-source address:port, которая позволяет задать новый IP-адрес источника пакета, и, при необходимости, порт.
* DNAT (только в таблице nat): применяет Destination Network Address Translation (DNAT). Дополнительные опции описывают то, какие именно изменения нужно выполнить, включая опцию --to-destination address:port, которая позволяет задать новый IP-адрес назначения, и, при необходимости, порт.
* MASQUERADE (только в таблице nat): выполняет так называемый маскарадинг (особый случай Source NAT).
* REDIRECT (только в таблице nat): прозрачно перенаправляет пакет на заданный порт самого файрвола. Это действие можно использовать для установки прозрачного веб-прокси, который работает без дополнительных настроек на стороне клиента, так как клиент полагает, что он подключён к получателю, в то время как обмен данными, на самом деле, идёт через прокси. Опция --to-ports port(s) позволяет указать порт или диапазон портов, на которые должны быть перенаправлены пакеты.
### Базовые цепочки
Существует 5 базовых цепочек и различаются они в зависимости от того, какое назначение имеет пакет. Имена базовых цепочек записываются в верхнем регистре.

* PREROUTING - правила в этой цепочке применяются ко всем пакетам, которые поступают на сетевой интерфейс извне;
* INPUT - применяются к пакетам, которые предназначаются для самого хоста или для локального процесса, запущенного на данном хосте. То есть не являются транзитными;
* FORWARD - правила, которые применяются к транзитным пакетам, проходящими через хост, не задерживаясь;
* OUTPUT - применяются к пакетам, которые сгенерированы самим хостом;
* POSTROUTING - применяются к пакетам, которые должны покинуть сетевой интерфейс.
  
В базовых цепочках обязательно устанавливается политика по умолчанию, как правило – принимать (ACCEPT) или сбрасывать (DROP) пакеты. Действует она только в цепочках INPUT, FORWARD и OUTPUT

Начнем работы с IPTABLES
--------------------------

Итак, IPTABLES, как мы выяснили ранее - это утилита для настройки программного Firewall'а (межсетевого экрана) linux, которая предустанавливается по умолчанию во все сборки Linux, начиная с версии 2.4. Запускается IPTABLES из командной строки (CLI) под пользователем с правами root и настраивается там же.

С помощью него можно решить следующие задачи:

* Настроить stateless и statefull фильтрацию пакетов версий IPv4 и IPv6
>Stateless - это фильтрация, основанная на проверке статических параметров одного пакета, например: IP адрес источника и получателя, порт и другие не изменяющиеся параметры.

>Statefull - это фильтрация, основанная на анализе потоков трафика. С помощью нее можно определить параметры целой TCP сессии или UDP потока.
* Настраивать все виды трансляции IP адресов и портов NAT, PAT, NAPT
* Настроить политики QoS
> QoS это возможность сети обеспечить специальный уровень обслуживания для конкретных пользователей или приложений без ущерба остальному трафику. Главная цель QoS это обеспечение более предсказуемого поведения сети передачи данных при работе с тем, или иным типом трафика, путем обеспечения необходимой полосы пропускания, контролем над задержкой и джиттером и улучшением характеристик при потере пакетов. Алгоритмы QoS достигают этих целей путем ограничения трафика, более эффективным использованием каналов передачи, и назначением тех или иных политик к трафику. QoS обеспечивает интеллектуальную передачу поверх корпоративной сети, и, при правильной настройке, улучшает показатели производительности.
* Производить различные манипуляции с пакетами, например - изменять поля в заголовке IP.

## Синтаксис IPTABLES

Полный список ключей и параметров вы можете найти в официальном гайде на iptables.org, тут преведу основные ключи которые чаще всего используються или обязательны. 

### Для редактирования цепочек. Добавления, удаления, замены.

| Коротко       | Синтаксис правила  | Применение                           |
|---------------|----------------|---------------------------------------|
|-A	|--append {цепочка правила}|	добавить правило к цепочке (в самое начало)
|-D	|--delete {цепочка правила}|	удалить правило из цепочки
|-D	|--delete {номер правила в цепочке}|	удалить правило из цепочки по номеру (1 - x)
|-I	|--insert {номер правила вцепочке}|	вставить правило в цепочку по номеру (1 - x)
|-R	|--replace {номер правила вцепочке}|	заменить правило в цепочке по номеру (1 - x)
|-X	|--delete-chain {цепочка}|	удалить цепочку (только для пользовательских)
|-E	|--rename-chain {старое имя цепочки} {новое имя цепочки}|	переименовать цепочку
|-N	|--new {имя цепочки}|	создание новой пользовательской цепочки
|-C	|--check {правило цепочки}|	проверит наличие правила в цепочке
|-F	|-flush {цепочка}|	удаляет все правила в цепочке, если цепочка не указана – удалятся все правила
|-Z	|--zero {цепочка} {номер правила вцепочке}|	обнуляет все счётчики пакетов и байтов в цепочке или всех цепочках
|-P	|-policy {цепочка} {номер правила вцепочке}|	изменяет политику по умолчанию, она должна основываться на встроенном target’e {ACCEPT, DROP, QUEUE}

### Для настройки источника и назначения. На каком сетевом интерфейсе следить за пакетами, какой протокол проверять, адрес источника, назначения.

| Коротко       | Синтаксис правила  | Применение                           |
|---------------|----------------|---------------------------------------|
|-p|	(!) --proto {протокол}|	протокол {tcp, udp, udplite, icmp, esp, ah, sctp} или номер протокола {16,7}, all - все протоколы
|-4|	--ipv4|	указывает версию протокола ipv4
|-6|	--ipv6|	указывает версию протокола ipv6
|-s|	(!) --source {адрес/маска}|	указывает ip адрес источника
|-d|	(!) --destination {адрес/маска}|	указывает ip адрес назначения
|-m|--match|	включает дополнительные модули, явно задающимися данным ключем. например <code>m limit --limit 3/min</code> - установит лимит на количество пакетов в минуту
|-f|	(!) --fragment|	включает обработку фрагментированных пакетов, в которых нет параметров изначального полного пакета, содержащихся в первом фрагменте пакета
|-i|	(!) --in-interface {имя интерфейса}|	обрабатывает только входящие пакеты, прилетающие на сетевой интерфейс {имя интерфейса}
|-o|	(!) --out-interface {имя интерфейса}|	обрабатывает только исходящие пакеты, прилетающие на сетевой интерфейс {имя интерфейса}
|  |--set-counters {пакеты} {байты}|	включает счётчик для ключей--insert, --append, --replace

### Для обозначения действия, что делать с данным правилом\цепочкой при совпадении.

| Коротко       | Синтаксис правила  | Применение                           |
|---------------|----------------|---------------------------------------|
|-j|	--jump {действие}|	применяет одно из действий accept, drop, reject и другие
|-g|	--goto {цепочка}|	переходит к другой цепочке правил